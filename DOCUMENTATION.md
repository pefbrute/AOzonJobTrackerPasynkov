# Документация проекта: AOzonJobTracker (Ozon Job Watcher)

## 1. Общее описание
**AOzonJobTracker** — это Android-приложение, предназначенное для автоматизации процесса поиска и записи на рабочие смены в приложении "Ozon Job" (ru.ozon.hire). Система в фоновом режиме отслеживает появление свободных слотов для конкретной вакансии ("Производство непрофиль") на определенном складе ("Петровское") и уведомляет пользователя о найденных датах.

## 2. Архитектура системы
Проект состоит из трех основных компонентов:

### A. MainActivity (Интерфейс управления)
* **Технологии:** Jetpack Compose.
* **Функции:**
    * Визуальный мониторинг статуса сервисов (Accessibility ACTIVE/DISABLED).
    * Настройка параметров задержки (`action_delay`) и быстрого обновления (`refresh_delay`).
    * Включение/выключение режима быстрого обновления (`fast_refresh`).
    * Просмотр логов работы в реальном времени.
    * Быстрые переходы в системные настройки (Спец. возможности, Батарея, Поверх других окон).

### B. JobMonitoringService (Фоновый контроллер)
* **Тип:** Foreground Service.
* **Задачи:**
    * Удержание процесса в памяти Android (безостановочная работа).
    * Планирование периодических циклов проверки (каждые ~30 секунд).
    * Управление "пробуждением" устройства (WakeLock) — разблокировка и включение экрана перед проверкой.
    * Отправка системных уведомлений при обнаружении слотов.
    * Обновление статуса в шторке ("Last check: HH:mm").

### C. OzonJobAccessibilityService (Двигатель автоматизации)
Это ключевой компонент, использующий Android Accessibility API для "чтения" экрана и имитации действий пользователя.

#### Логика работы (State Machine):
Сервис работает как конечный автомат со следующими состояниями:
1. **IDLE:** Ожидание запроса на проверку.
2. **BOOTSTRAP_DETECT_AND_ROUTE:** *(NEW)* Определение текущего экрана и выбор оптимального маршрута.
3. **RECOVERY:** *(NEW)* Восстановление при неизвестном экране (Back/Home + relaunch).
4. **FIND_WAREHOUSES_TAB:** Поиск и нажатие на вкладку "Склады".
5. **FIND_SEARCH_FIELD:** Ожидание появления поля поиска и клик по иконке лупы.
6. **TYPE_SEARCH_QUERY:** Ввод названия города ("Петровское") в поисковую строку.
7. **SELECT_WAREHOUSE:** Выбор нужной карточки склада из результатов поиска (рекурсивный поиск по тексту).
8. **CLICK_ENROLL:** Нажатие кнопки "Записаться" на странице склада.
9. **FIND_JOB_CARD:** Поиск конкретной вакансии ("Производство непрофиль") в списке работ.
10. **CHECK_SLOTS:** Анализ дат под вакансией.
11. **REFRESH_BACK:** Специальное состояние для возврата назад в режиме Fast Refresh.

### D. ScreenDetector *(NEW)*
Определяет текущий экран Ozon Job по якорным элементам:
* **RECORDS_MAIN** — главный экран "Записи"
* **WAREHOUSES_LIST** — экран "Выберите склад"
* **WAREHOUSE_CARD_PETROVSKOE** — карточка склада
* **WORKS_LIST_PETROVSKOE** — список работ

Использует confidence scoring (0.0-1.0) для надёжного распознавания.

### E. Router *(NEW)*
Выбирает кратчайший путь к цели на основе текущего экрана, пропуская уже пройденные шаги.

### F. RecoveryManager *(NEW)*
Управляет восстановлением при неизвестном экране:
* **Back Recovery:** до 5 нажатий BACK с проверкой экрана
* **Home + Relaunch:** если BACK не помог
* **Safe Mode:** пауза на 5 минут при 3+ последовательных провалах
* **Backoff:** увеличение интервала при повторных провалах

## 3. Ключевые алгоритмы и особенности

### Рекурсивный поиск нод (findNodeRecursive)
В отличие от стандартного поиска Android, сервис вручную обходит всё дерево элементов (AccessibilityNodeInfo). Это позволяет находить элементы в динамических списках Jetpack Compose, которые стандартные методы часто "пропускают".

### Анализ доступности слотов
Система не просто ищет текст, она:
1. Собирает все текстовые элементы на странице вакансий.
2. Использует регулярное выражение `\d+\s+[а-яА-Я]+,\s+[а-яА-Я]{2}` для поиска дат (например, "7 февраля, Сб").
3. Проверяет наличие надписи "НЕТ МЕСТ" рядом с вакансией.
4. Формирует список доступных дней для вывода в уведомление.

### Режим Fast Refresh (Быстрое обновление)
Если слоты не найдены, сервис может не выходить из приложения, а выполнить цикл: `Назад -> Повторное нажатие "Записаться"`. Это позволяет обновить информацию быстрее, чем при полном перезапуске приложения. Лимит — 10 циклов на одну сессию.

### Система обхода ограничений Android
* **WakeLock:** Используется для "пробуждения" процессора.
* **PowerManager:** Включает экран (ACQUIRE_CAUSES_WAKEUP).
* **KeyguardManager:** Программный запрос на разблокировку экрана.

## 4. Настройка и запуск
1. **Разрешения:** Приложению требуются права на уведомления, работу поверх окон, игнорирование оптимизации батареи и, самое главное, доступ к Спец. возможностям.
2. **Параметры:**
    * Рекомендуемая задержка (`Action Delay`): 2-4 секунды (зависит от скорости интернета и телефона).
    * `Fast Refresh Mode`: Рекомендуется для "часа пик", когда слоты появляются на секунды.

## 5. Безопасность и надежность
* **IsCheckRequested:** Флаг, предотвращающий случайные нажатия, если пользователь сам открыл Ozon Job. Сервис работает только тогда, когда запрос поступил от монитора.
* **Opportunistic Jumps:** Логика автоматического восстановления состояния. Если сервис видит кнопку "Записаться", он может перепрыгнуть сразу к ней, пропуская этапы поиска, если они уже были выполнены ранее.
