# Документация проекта: AOzonJobTracker (Ozon Job Watcher)

## 1. Общее описание
**AOzonJobTracker** — это профессиональный инструмент автоматизации для Android, предназначенный для мониторинга и захвата рабочих смен в приложении "Ozon Job" (ru.ozon.hire). Система сочетает в себе движок автоматизации на базе Accessibility API, систему аналитики для выявления паттернов появления слотов и интеллектуальную систему навигации.

## 2. Архитектура системы

### A. MainActivity (Управление и Аналитика)
Интерфейс разделен на две основные секции через **NavigationBar**:
1. **Monitor**: Пульт управления задержками, режимами (Fast Refresh), системными разрешениями и просмотр оперативных логов.
2. **Stats (NEW)**: Мощный аналитический модуль:
    * **Summary Cards**: Общее количество проверок, % успеха, количество найденных слотов.
    * **Heat Map**: Визуальная карта (24/7), показывающая плотность появления слотов по часам и дням недели. Помогает понять, в какое время бот наиболее эффективен.
    * **Recent History**: Детальный список последних 50+ проверок (включая промежуточные попытки в режиме Fast Refresh).

### B. Система хранения данных (Statistics Engine)
Реализована на базе **Room Persistence Library**:
* **CheckRecord (Entity)**: Хранит timestamp, результат (успех/ошибка), найденные даты, длительность цикла и текст ошибки.
* **StatsRepository**: Реактивный слой данных, который предоставляет Flow для UI и записывает каждый "вздох" сервиса автоматизации.
* **Автономность**: Данные сохраняются локально и доступны даже после перезагрузки.

### C. JobMonitoringService (Контроллер видимости)
* **Combined Notifications (NEW)**: Умная система уведомлений в шторке. Показывает одновременно:
    * **Результат**: Исходы последней проверки (напр. "No slots found (00:15)").
    * **Действие**: Текущий статус бота в реальном времени (напр. "Bot: Typing...").
* **Priority Alerts**: При нахождении слотов отправляется высокоприоритетное уведомление со звуком и вибрацией.

### D. OzonJobAccessibilityService (Двигатель автоматизации)
#### Оптимизация навигации:
* **Dynamic Delay Multipliers (NEW)**: Система умных задержек. Вместо фиксированных 3 секунд, бот использует коэффициенты:
    * `x0.3` для перехода к клавиатуре.
    * `x0.5` для выбора склада.
    * `x0.4` для перехода к списку работ.
    Это позволило ускорить прохождение навигационного пути в 2.5 раза.
* **Cycle-Level Logging**: Каждая попытка проверки (даже внутри быстрого рефреша) фиксируется в базе данных для полной прозрачности.

#### Логика работы (State Machine):
1. **IDLE**: Ожидание.
2. **BOOTSTRAP_DETECT_AND_ROUTE**: Определение экрана и выбор маршрута.
3. **RECOVERY**: Восстановление при сбоях (Back/Home/Relaunch).
4. **SELECT_WAREHOUSE**: Быстрый поиск и клик по "Петровское".
5. **CLICK_ENROLL**: Нажатие кнопки записи.
6. **CHECK_SLOTS**: Анализ дат с помощью Regex и Heuristic-анализа текста.
7. **REFRESH_BACK**: Быстрый откат назад для моментального обновления страницы.

## 3. Интеллектуальные компоненты

### ScreenDetector & Router
Система больше не "слепа". Она понимает, на каком экране находится, используя якорные элементы и весовые коэффициенты (Confidence Scoring). Если вы сами откроете экран со списком работ, бот поймет это и пропустит этап поиска склада, перейдя сразу к анализу слотов.

### RecoveryManager
Многоуровневая система защиты от "застревания":
* Мягкий выход (BACK) -> Жесткий перезапуск (HOME + Launch) -> Режим ожидания (Backoff) при серийных ошибках.

## 4. Алгоритм обнаружения слотов
1. Рекурсивный обход всего дерева элементов (даже невидимых для обычного поиска).
2. Фильтрация текста через Regex: `\d+\s+[а-яА-Я]+,\s+[а-яА-Я]{2}`.
3. Проверка контекста (отсутствие индикаторов "НЕТ МЕСТ").
4. Сравнение найденных дат с предыдущими результатами для исключения дубликатов в уведомлениях.

## 5. Настройка для максимальной эффективности
* **Action Delay**: Рекомендуется 2.0 - 3.0 сек (динамические коэффициенты сами ускорят навигацию).
* **Fast Refresh Mode**: Обязателен для активного вылова. Бот делает до 10 быстрых "прошариваний" страницы без перезапуска приложения.
* **Battery Settings**: Обязательно отключить ограничения экономии энергии, иначе Android "убьет" MonitoringService через 10-15 минут.

## 6. Безопасность
* Приложение работает только в рамках **Accessibility API**, не требуя Root-прав.
* Флаг `isCheckRequested` гарантирует, что бот не будет мешать вам, если вы просто решили почитать новости в Ozon Job самостоятельно.
